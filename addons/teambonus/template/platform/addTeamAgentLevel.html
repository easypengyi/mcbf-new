{block name="main"}
		<!-- page -->
		<form class="form-horizontal form-validate pt-15 widthFixedForm">
			<div class="form-group">
				<label class="col-md-2 control-label"><span class="text-bright">*</span>等级名称</label>
				<div class="col-md-5">
					<input type="text" class="form-control" name="level_name"  required>
				</div>
			</div>
			<div class="form-group">
				<label class="col-md-2 control-label"><span class="text-bright">*</span>分红类型</label>
				<div class="col-md-8">
					<div>
						<label class="radio-inline">
								<input type="radio" value="1" name="bonus_type" checked required> 按比例分红
						</label>
						<label class="radio-inline">
							<input type="radio" value="2" name="bonus_type" required> 按固定分红
						</label>
					</div>
				</div>
			</div>
			<div class="form-group J-bonus_ratio">
				<label class="col-md-2 control-label"><span class="text-bright">*</span>分红比例</label>
				<div class="col-md-5">
					<div class="input-group">
						<input type="number" class="form-control" min="0" max="100" name="ratio" required>
						<div class="input-group-addon">%</div>
					</div>
				</div>
			</div>
			<div class="form-group J-bonus_money hide">
				<label class="col-md-2 control-label"><span class="text-bright">*</span>分红金额</label>
				<div class="col-md-5">
					<div class="input-group">
						<input type="number" class="form-control" min="0" name="money" >
						<div class="input-group-addon">元</div>
					</div>
				</div>
			</div>
			<div class="return_commission1" >
				{if $website['level_award']>=1}
				<div class="form-group">
						<label class="col-md-2 control-label">平一级奖</label>
						<div class="col-md-5">
							<div class="input-group">
								<input type="number" class="form-control" min="0" name="level_award1">
								<div class="input-group-addon">%</div>
							</div>
						</div>
					</div>
				{/if}
				{if $website['level_award']>=2}
				<div class="form-group">
						<label class="col-md-2 control-label">平二级奖</label>
						<div class="col-md-5">
							<div class="input-group">
								<input type="number" class="form-control" min="0" name="level_award2" >
								<div class="input-group-addon">%</div>
							</div>
						</div>
					</div>
				{/if}
				{if $website['level_award']>=3}
				<div class="form-group">
						<label class="col-md-2 control-label">平三级奖</label>
						<div class="col-md-5">
							<div class="input-group">
								<input type="number" class="form-control" min="0" name="level_award3">
								<div class="input-group-addon">%</div>
							</div>
						</div>
					</div>
				{/if}
			</div>
			<div class="return_commission2 hide" >
				{if $website['level_award']>=1}
				<div class="form-group">
					<label class="col-md-2 control-label">平一级奖</label>
					<div class="col-md-5">
						<div class="input-group">
							<input type="number" class="form-control" min="0" name="level_money1">
							<div class="input-group-addon">元</div>
						</div>
					</div>
				</div>
				{/if}
				{if $website['level_award']>=2}
				<div class="form-group">
					<label class="col-md-2 control-label">平二级奖</label>
					<div class="col-md-5">
						<div class="input-group">
							<input type="number" class="form-control" min="0" name="level_money2" >
							<div class="input-group-addon">元</div>
						</div>
					</div>
				</div>
				{/if}
				{if $website['level_award']>=3}
				<div class="form-group">
					<label class="col-md-2 control-label">平三级奖</label>
					<div class="col-md-5">
						<div class="input-group">
							<input type="number" class="form-control" min="0" name="level_money3">
							<div class="input-group-addon">元</div>
						</div>
					</div>
				</div>
				{/if}
			</div>
			<div class="form-group">
				<label class="col-md-2 control-label">自动升级</label>
				<div class="col-md-5">
					<div class="switch-inline">
						<input type="checkbox" id="upgrade-switch" value="1" name="upgradetype">
						<label for="upgrade-switch"></label>
					</div>
					<div class="help-block mb-0">开启后满足一定条件自动升级，关闭后则该等级不会自动升级。</div>
				</div>
			</div>
			<div id="isupgrade" class="hide">
				<div class="form-group">
					<label class="col-md-2 control-label">升级条件</label>
					<div class="col-md-5">
						<div>
						<label class="radio-inline">
							<input type="radio"   value="1" name="upgradecondition"> 满足所有勾选条件
						</label>
						<label class="radio-inline">
							<input type="radio"  value="2" name="upgradecondition"> 满足勾选条件之一即可
						</label>
						</div>
					</div>
				</div>
				<div class="form-group" id="upgrade-condition">
					<label class="col-md-2 control-label"></label>
					<div class="col-md-8">
						<div class="form-additional" style="width: auto">
							<div class="form-group">
								<label class="col-md-4 control-label"><input type="checkbox" name="upgradeconditions" value="1"> 内购订单金额满</label>
								<div class="col-md-7 control-group">
									<div class="input-group">
										<input type="number" class="form-control" min="0" name="pay_money">
										<div class="input-group-addon">元</div>
									</div>
								</div>
							</div>
							<div class="form-group">
								<label class="col-md-4 control-label"><input type="checkbox" name="upgradeconditions" value="3"> 一级分销商满</label>
								<div class="col-md-7 control-group">
									<div class="input-group">
										<input type="number" class="form-control" min="0" name="one_number">
										<div class="input-group-addon">人</div>
									</div>
								</div>
							</div>
							<div class="form-group">
								<label class="col-md-4 control-label"><input type="checkbox" name="upgradeconditions" value="4"> 二级分销商满</label>
								<div class="col-md-7 control-group">
									<div class="input-group">
										<input type="number" class="form-control" min="0" name="two_number" >
										<div class="input-group-addon" >人</div>
									</div>
								</div>
							</div>
							<div class="form-group">
								<label class="col-md-4 control-label"><input type="checkbox" name="upgradeconditions" value="5"> 三级分销商满</label>
								<div class="col-md-7 control-group">
									<div class="input-group">
										<input type="number" class="form-control" min="0" name="three_number">
										<div class="input-group-addon">人</div>
									</div>
								</div>
							</div>
							<div class="form-group">
								<label class="col-md-4 control-label"><input type="checkbox" name="upgradeconditions" value="8"> 下线客户数达</label>
								<div class="col-md-7 control-group">
									<div class="input-group">
										<input type="number" class="form-control" min="0" name="offline_number">
										<div class="input-group-addon">人(非分销商)</div>
									</div>
								</div>
							</div>
							<div class="form-group">
								<label class="col-md-4 control-label"><input type="checkbox" name="upgradeconditions" value="2"> 团队人数</label>
								<div class="col-md-7 control-group">
									<div class="input-group">
										<input type="number" class="form-control" min="0" name="group_number">
										<div class="input-group-addon">人(分销商)</div>
									</div>
								</div>
							</div>
							<div class="form-group">
								<label class="col-md-4 control-label"><input type="checkbox" name="upgradeconditions" value="9"> 指定推荐等级</label>
								<div class="col-md-7 control-group">
									<div class="input-group">
										<select class="form-control upgrade_level" style="min-width: 130px" name="upgrade_level">
											{foreach $level_info as $v}
											<option value="{$v['id']}">{$v['level_name']}</option>
											{/foreach}
										</select>
										<div class="input-group-addon">达</div>
										<input type="number" class="form-control" min="0" name="level_number">
										<div class="input-group-addon">人</div>
									</div>
								</div>
							</div>
							<div class="form-group">
								<label class="col-md-4 control-label"><input type="checkbox" name="upgradeconditions" value="6"> 一级订单金额满</label>
								<div class="col-md-7 control-group">
									<div class="input-group">
										<input type="number" class="form-control" min="0" name="order_money">
										<div class="input-group-addon">元</div>
									</div>
								</div>
							</div>
							<div class="form-group">
								<label class="col-md-4 control-label"><input type="checkbox" name="upgradeconditions" value="11"> 团队订单金额满</label>
								<div class="col-md-7 control-group">
									<div class="input-group">
										<input type="number" class="form-control" min="0" name="up_team_money" >
										<div class="input-group-addon">元</div>
									</div>
								</div>
							</div>
							<div class="form-group">
								<label class="col-md-4 control-label"><input type="checkbox" name="upgradeconditions" value="7"> 购买指定商品</label>
								<div class="col-md-7 control-group">
									<div class="input-group">
										<a class="btn btn-primary search_goods2"> 挑选商品</a>
										<input hidden type="text" id="selectgoods_ids" name="selectgoods_ids"  value="{$website['goodsid']}">
									</div>
								</div>
								<div class="col-md-12 control-group">
									<table class="table v-table table-auto-center" id="selfGoodsList">
											<thead>
											<tr>
												<th class="col-md-4">商品信息</th>
												<th >库存</th>
												<th class="col-md-2 pr-14 operationLeft">操作</th>
											</tr>
											</thead>
											<tbody id="goods_list">
												
											</tbody>
										</table>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="form-group">
				<label class="col-md-2 control-label">自动降级</label>
				<div class="col-md-5">
					<div class="switch-inline">
						<input type="checkbox" id="downgrade-switch" value="1" name="downgradetype">
						<label for="downgrade-switch"></label>
					</div>
					<div class="help-block mb-0">开启后不满足指定条件自动降级，关闭后则该等级不会自动降级。</div>
				</div>
			</div>
			<div id="isdowngrade" class="hide">
				<div class="form-group">
					<label class="col-md-2 control-label">降级条件</label>
					<div class="col-md-5">
						<div>
						<label class="radio-inline">
							<input type="radio"  value="1" name="downgradecondition"> 满足所有勾选条件
						</label>
						<label class="radio-inline">
							<input type="radio" value="2" name="downgradecondition"> 满足勾选条件之一即可
						</label>
						</div>
					</div>
				</div>
				<div class="form-group" id="downgrade-condition">
					<label class="col-md-2 control-label"></label>
					<div class="col-md-8">
						<div class="form-additional" style="width: auto">
							<div class="form-group">
								<label class="col-md-4 control-label"><input type="checkbox" name="downgradeconditions" value="1"> 团队订单量</label>
								<div class="col-md-7 control-group">
									<div class="input-group">
										<input type="number" class="form-control" min="0" name="team_number_day">
										<div class="input-group-addon">天内，少于</div>
										<input type="number" class="form-control" min="0" name="team_number">
										<div class="input-group-addon">单</div>
									</div>
								</div>
							</div>
							<div class="form-group">
								<label class="col-md-4 control-label"><input type="checkbox" name="downgradeconditions" value="2"> 团队订单金额</label>
								<div class="col-md-7 control-group">
									<div class="input-group">
										<input type="number" class="form-control" min="0" name="team_money_day">
										<div class="input-group-addon">天内，少于</div>
										<input type="number" class="form-control" min="0" name="team_money">
										<div class="input-group-addon">元</div>
									</div>
								</div>
							</div>
							<div class="form-group">
								<label class="col-md-4 control-label"><input type="checkbox" name="downgradeconditions" value="3"> 内购订单金额</label>
								<div class="col-md-7 control-group">
									<div class="input-group">
										<input type="number" class="form-control" min="0" name="self_money_day">
										<div class="input-group-addon">天内，少于</div>
										<input type="number" class="form-control" min="0" name="self_money">
										<div class="input-group-addon">元</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="form-group">
				<label class="col-md-2 control-label"><span class="text-bright">*</span>权重</label>
				<div class="col-md-5">
					<input type="number" class="form-control" name="weight" required >
					<div class="help-block mb-0">等级权重，数字越大级别越高。按设置的权重大小从低到高进行升级。</div>
				</div>
			</div>
			<div class="form-group"></div>
			<div class="form-group">
				<label class="col-md-2 control-label"></label>
				<div class="col-md-8">
					<button class="btn btn-primary add" type="submit">添加</button>
					<a href="javascript:history.go(-1);" class="btn btn-default">返回</a>
				</div>
			</div>
		</form>

		<input type="hidden" value="{$level_weight}" id="level_weight">


		<!-- page end -->

{/block}
{block name="script"}
<script>
    require(['util'],function(util){
        $("#upgrade-switch").change(function () {
            var upgradetype = $("input[name='upgradetype']:checked").val();
            if(upgradetype==1){
                $("input[name='upgradecondition']").attr("required",true);
				$("#isupgrade").removeClass("hide");
            }else{
                $("input[name='upgradecondition']").removeAttr("required",true);
				$("#isupgrade").addClass("hide");
            }
        })
        $("#downgrade-switch").change(function () {
            var downgradetype = $("input[name='downgradetype']:checked").val();
            if(downgradetype==1){
                $("input[name='downgradecondition']").attr("required",true);
				$("#isdowngrade").removeClass("hide");
            }else{
                $("input[name='downgradecondition']").removeAttr("required",true);
				$("#isdowngrade").addClass("hide");
            }
        })
        $("input[name='upgradeconditions']").click(function () {
            if($(this).is(':checked')){
                var vals=$(this).val();
                if(vals!=7 || $("input[name='selectgoods_id']").val()==''){
                    $(this).parent(".control-label").siblings(".control-group").find("input").attr("required",true);
                }
            } else{
                $(this).parents(".form-group").removeClass('has-error');
                $(this).parents(".form-group").find('.help-block-error').html('');
                $(this).parent(".control-label").siblings(".control-group").find("input").removeAttr("required",true);
            }
        })
        $("input[name='downgradeconditions']").click(function () {
            if($(this).is(':checked')){
                $(this).parent(".control-label").siblings(".control-group").find("input").attr("required",true);
            } else{
                $(this).parents(".form-group").removeClass('has-error');
                $(this).parents(".form-group").find('.help-block-error').html('');
                $(this).parent(".control-label").siblings(".control-group").find("input").removeAttr("required",true);
            }
        })
        $("input[name='weight']").on('blur',function () {
            var weight = $("input[name='weight']").val();
            var arr = $("#level_weight").val();
            arr = arr.split(',');
            for(var i = 0; i < arr.length; i++){
                if(weight === arr[i]){
                    util.message('该等级权重值已存在','danger');
                    $("input[name='weight']").val('');
                    return false;
                }
            }
        })
        function isInArray(arr,value){
            for(var i = 0; i < arr.length; i++){
                if(value === arr[i]){
                    return true;
                }
            }
            return false;
        }
        util.validate($('.form-validate'),function(form){
            var level_name = $("input[name='level_name']").val();
            var ratio = $("input[name='ratio']").val();
            var upgradetype = $("input[name='upgradetype']:checked").val();
            var upgrade_level = $(".upgrade_level").val();
            var level_number = $("input[name='level_number']").val();
            var offline_number = $("input[name='offline_number']").val();
            var group_number = $("input[name='group_number']").val();
            var one_number = $("input[name='one_number']").val();
            var two_number = $("input[name='two_number']").val();
            var three_number = $("input[name='three_number']").val();
            var order_money = $("input[name='order_money']").val();
            var pay_money = $("input[name='pay_money']").val();
            var downgradetype = $("input[name='downgradetype']:checked").val();
            var team_number = $("input[name='team_number']").val();
            var team_money = $("input[name='team_money']").val();
            var up_team_money = $("input[name='up_team_money']").val();
            var self_money = $("input[name='self_money']").val();
            var team_number_day = $("input[name='team_number_day']").val();
            var team_money_day = $("input[name='team_money_day']").val();
            var self_money_day = $("input[name='self_money_day']").val();
            var upgrade_condition = $("input[name='upgradecondition']:checked").val();
            var downgrade_condition = $("input[name='downgradecondition']:checked").val();
            var weight = $("input[name='weight']").val();
			var level_award1 = $("input[name='level_award1']").val();//平1级
            var level_award2 = $("input[name='level_award2']").val();//平2
            var level_award3 = $("input[name='level_award3']").val();//平3
			var level_money1 = $("input[name='level_money1']").val();//平1级
            var level_money2 = $("input[name='level_money2']").val();//平2
            var level_money3 = $("input[name='level_money3']").val();//平3
            var upgradeconditions = $("input:checkbox[name='upgradeconditions']:checked").map(function(index,elem) {
                return $(elem).val();
            }).get().join(',');
            var bonus_type = $('input[name=bonus_type]:checked').val();
            var money = $('input[name=money]').val();
            var arr=upgradeconditions.split(',');
            if(isInArray(arr,"7")){
                var goods_id = $("input[name='selectgoods_ids']").val();
				var strs = new Array(); //定义一数组
				strs = goods_id.split(","); //字符分割
				for (i=0; i<strs.length; i++ ){
					if(strs[i] == 0 || strs[i] == '' || strs[i] == null){
						strs.splice(i,1)
					}
				}
				if(strs.length>0){
					goods_id = strs.join(",");
					
				}else{
					goods_id = ''
					
				}
            }else{
                var goods_id ='';
            }
            var downgradeconditions = $("input:checkbox[name='downgradeconditions']:checked").map(function(index,elem) {
                return $(elem).val();
            }).get().join(',');
            if(upgradetype==1 && upgradeconditions==''){
                util.message('请填写升级条件','danger');
                return false;
            }
            if(downgradetype==1 && downgradeconditions==''){
                util.message('请填写降级条件','danger');
                return false;
            }
            $('.add').attr({disabled: "disabled"}).html('提交中...');
            $.ajax({
                type: "post",
                url: "{$addTeamAgentLevelUrl}",
                data: {
					'level_award1':level_award1,
                    'level_award2':level_award2,
                    'level_award3':level_award3,
					'level_money1':level_money1,
                    'level_money2':level_money2,
                    'level_money3':level_money3,
                    'upgrade_level':upgrade_level,
                    'level_number':level_number,
                    'offline_number':offline_number,
                    'group_number':group_number,
                    'level_name':level_name,
                    'ratio':ratio,
                    'upgradetype': upgradetype,
                    'one_number':one_number,
                    'two_number':two_number,
                    'three_number':three_number,
                    'pay_money':pay_money,
                    'order_money':order_money ,
                    'downgradetype':downgradetype,
                    'team_number':team_number,
                    'team_money':team_money,
                    'up_team_money':up_team_money,
                    'self_money':self_money,
                    'team_number_day':team_number_day,
                    'team_money_day':team_money_day,
                    'self_money_day':self_money_day,
                    'weight': weight,
                    'downgradeconditions':downgradeconditions,
                    'upgradeconditions': upgradeconditions,
                    'downgrade_condition':downgrade_condition,
                    'upgrade_condition': upgrade_condition,
                    'goods_id':goods_id,
					'bonus_type':bonus_type,
					'money':money,
                },
                async: true,
                success: function (data) {
                    if (data['code'] > 0) {
                        util.message(data["message"], 'success', "{:__URL('ADDONS_MAINteamAgentLevelList')}");
                    } else {
                        if(data['code'] ==-2){
                            util.message('该等级已存在', 'danger');
                        }else if(data['code'] ==-3) {
                            util.message('等级总比例超过100%', 'danger');
                        }else{
                            util.message(data["message"], 'danger');
						}
                        $('.add').removeAttr('disabled').html('添加');
                    }
                }
            });

        })
        
		$('body').on('change', 'input[name=bonus_type]', function(){
		    if($(this).val() == 1){
                $('.J-bonus_money').removeClass('show');
                $('.J-bonus_money').addClass('hide');
                $('input[name=money]').attr('required', false);
                $('input[name=ratio]').attr('required', true);
                $('.J-bonus_ratio').removeClass('hide');
                $('.J-bonus_ratio').addClass('show');
                $('.return_commission1').removeClass('hide');
                $('.return_commission1').addClass('show');
                $('.return_commission2').removeClass('show');
                $('.return_commission2').addClass('hide');
                $('input[name=level_money1]').attr('required', false);
                $('input[name=level_award1]').attr('required', true);
                $('input[name=level_money2]').attr('required', false);
                $('input[name=level_award2]').attr('required', true);
                $('input[name=level_money3]').attr('required', false);
                $('input[name=level_award3]').attr('required', true);
			}else{
                $('.J-bonus_ratio').removeClass('show');
                $('.J-bonus_ratio').addClass('hide');
                $('input[name=ratio]').attr('required', false);
                $('.J-bonus_money').removeClass('hide');
                $('.J-bonus_money').addClass('show');
                $('.return_commission1').removeClass('show');
                $('.return_commission1').addClass('hide');
                $('.return_commission2').removeClass('hide');
                $('.return_commission2').addClass('show');
                $('input[name=level_award1]').attr('required', false);
                $('input[name=level_money1]').attr('required', true);
                $('input[name=level_award2]').attr('required', false);
                $('input[name=level_money2]').attr('required', true);
                $('input[name=level_award3]').attr('required', false);
                $('input[name=level_money3]').attr('required', true);
            }
		})
		$('body').on('click','.search_goods2', function () {
			var url = "{:__URL('PLATFORM_MAIN/goods/selectNumGoodsList')}?goodsid="+$("#selectgoods_ids").val();
            util.confirm('选择商品','url:'+url, function () {
                var goods_id = this.$content.find('#goods_id').val();
				// console.log('goods_id',goods_id)
				$("#selectgoods_ids").val(goods_id);
                $.ajax({
                    type:"post",
                    url:" {:__URL('PLATFORM_MAIN/goods/selectNumGoodsInfo')}",
                    data:{
                        'goods_id':goods_id,
                    },
                    async:true,
                    success:function (data) {
                        if (data) {
                            var html='';
                            for(var i=0;i<data.length;i++){
								html += '<tr>';
								html += '<td>';
								html += '<div class="showUser media text-left ">';
								html += '<div class="media-left"><img id="actar" src="'+data[i]['pic_cover_small']+'" style="max-width:none;width:60px;height:60px;"></div>';
								html += '<div class="media-body break-word">';
								html += '<div class="line-2-ellipsis nick_name">'+data[i]['goods_name']+'</div>';
								html += '<div class="line-1-ellipsis text-danger mobile">'+data[i]['price']+'</div>';
								html += '</div>';
								html += '</div>';
								html += '</td>';
								html += '<td>'+data[i]['stock']+'</td>';
								html += '<td class="text-red1 btn-operation col-md-2 pr-14 operationLeft" data-id="'+data[i]['goods_id']+'" style="cursor:pointer">删除</td>';
								html += '</tr>';
							}
                            $('#goods_list').html(html);
                        }
                    }
                });
            },'large')
            
        })
		$('body').on('click','.operationLeft', function () {
			$(this).parents('tr').remove();
			var id = $(this).data('id');
			changeGoods(id,1);
		})
		function changeGoods(id,type){
			var selectgoods_ids = $('#selectgoods_ids').val();
			if(type == 1){
				//删除
				var strs = new Array(); //定义一数组
				strs = selectgoods_ids.split(","); //字符分割
				
				for (i=0; i<strs.length; i++ ){
					if(strs[i] == id){
						strs.splice(i,1)
					}
				}
				console.log('delect',strs)
				if(strs.length>0){
					b = strs.join(",");
					console.log('b',b);
					$("#selectgoods_ids").val(b);
				}else{
					$("#selectgoods_ids").val('');
					$('#selfGoodsList').addClass('hide');
				}
			}else{
				//增加
				$('#selfGoodsList').removeClass('hide');
				//存在则更新 不存在则直接写入
				if(selectgoods_ids){
					var str = selectgoods_ids + ','+id;
					console.log('str',str)
					$("#selectgoods_ids").val(str);
				}else{
					$("#selectgoods_ids").val(id);
				}
			}
		}
		$('.picture-list1').on('click','.icon-danger',function(e){
            e && e.stopPropagation ? e.stopPropagation() : window.event.cancelBubble = true;
            var id=$(this).parents('.picture-list1-pic').attr('data-id');
            $(this).parents('.picture-list1-pic').remove();
            var str=$("#goodsid").val();
            var str1 = str.split(',');
			console.log('str1',str1,'id',id)
            str1.remove(id);
            var str2 = str1.join(',');
            $("#goodsid").val(str2);
			if(str2 == ''){
				var html='<div class="empty-box" style="border:none">暂无商品</div>';
				$(".picture-list1").html(html);
			}
        })
    })
</script>
{/block}